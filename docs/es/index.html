<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MixMaster - Suburbio Studios</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/es/courses.css">
</head>
<body>

<header>
  <h1><a href="https://suburstudios.com">Suburbio Studios</a></h1>
  <nav>
    <a href="/es/">Inicio</a>
    <a href="/es/cursos">Cursos</a>
    <a href="/es/contacto">Contacto</a>
  </nav>
</header>

<main>
  <section class="projects">
    <h2>Ejemplos de mezcla y mastering</h2>

    <!-- Ejemplo 1 -->
    <div class="project-card"
         data-before="/es/audio_mastering/CHILL_HOUSE_NO_MASTERING.mp3"
         data-after="/es/audio_mastering/CHILL_HOUSE_MASTERING.mp3"
         data-type="master">
      <img class="project-thumbnail" src="/images/MASTERING_EXAMPLE.png" alt="Master 1">
      <h3>Deep House Mastering</h3>
      <div class="player">
        <button class="play-btn">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <path d="M5 3v18l15-9L5 3z" fill="#FFFFFF"/>
          </svg>
        </button>
        <input type="range" value="0" min="0" max="100" step="0.1">
        <span class="time">0:00</span>
        <div class="toggle">
          <span class="label-before">Antes</span>
          <div class="toggle-btn"><div class="toggle-circle"></div></div>
          <span class="label-after">Después</span>
        </div>
      </div>
    </div>

    <!-- Ejemplo 2 -->
    <div class="project-card"
         data-before="/es/audio_mastering/METAL_NO_MASTERING.mp3"
         data-after="/es/audio_mastering/METAL_MASTERING.mp3"
         data-type="master">
      <img class="project-thumbnail" src="/images/METAL_EXAMPLE.png" alt="Master 2">
      <h3>Metal Mastering</h3>
      <div class="player">
        <button class="play-btn">
          <svg width="18" height="18" viewBox="0 0 24 24">
            <path d="M5 3v18l15-9L5 3z" fill="#FFFFFF"/>
          </svg>
        </button>
        <input type="range" value="0" min="0" max="100" step="0.1">
        <span class="time">0:00</span>
        <div class="toggle">
          <span class="label-before">Antes</span>
          <div class="toggle-btn"><div class="toggle-circle"></div></div>
          <span class="label-after">Después</span>
        </div>
      </div>
    </div>

  </section>
</main>

<footer>
  <p>&copy; 2025 Suburbio Studios - MixMaster</p>
</footer>

<script>
(async function() {
  if (!window.AudioContext && !window.webkitAudioContext) {
    alert("Tu navegador no soporta Web Audio API. El reproductor puede no funcionar correctamente.");
    return;
  }

  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AudioCtx();

  function fmtTime(t) {
    if (!isFinite(t) || t < 0) return "0:00";
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
  }

  async function loadBuffer(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Error cargando " + url);
    const arrayBuffer = await res.arrayBuffer();
    return await audioCtx.decodeAudioData(arrayBuffer.slice(0));
  }

  const PLAY_SVG = '<svg width="18" height="18" viewBox="0 0 24 24"><path d="M5 3v18l15-9L5 3z" fill="#FFFFFF"/></svg>';
  const PAUSE_SVG = '<svg width="18" height="18" viewBox="0 0 24 24"><rect x="5" y="4" width="4" height="16" fill="#FFFFFF"/><rect x="15" y="4" width="4" height="16" fill="#FFFFFF"/></svg>';

  document.querySelectorAll(".project-card").forEach(card => {
    const beforeUrl = card.dataset.before;
    const afterUrl = card.dataset.after;

    const playBtn = card.querySelector(".play-btn");
    const rangeEl = card.querySelector("input[type=range]");
    const timeEl = card.querySelector(".time");
    const toggle = card.querySelector(".toggle-btn");

    let beforeBuffer = null, afterBuffer = null;
    let duration = 0;
    let isLoaded = false;
    let isPlaying = false;
    let activeIsAfter = false;
    let position = 0;
    let startTimestamp = 0;

    const beforeGainNode = audioCtx.createGain();
    const afterGainNode = audioCtx.createGain();
    const masterGain = audioCtx.createGain();
    masterGain.gain.value = 1;
    beforeGainNode.connect(masterGain);
    afterGainNode.connect(masterGain);
    masterGain.connect(audioCtx.destination);

    let beforeSource = null, afterSource = null;

    async function ensureLoaded() {
      if (isLoaded) return;
      [beforeBuffer, afterBuffer] = await Promise.all([loadBuffer(beforeUrl), loadBuffer(afterUrl)]);
      duration = beforeBuffer.duration;
      rangeEl.max = duration;
      isLoaded = true;
    }

    function stopAll() {
      if (beforeSource) { beforeSource.stop(); beforeSource.disconnect(); beforeSource = null; }
      if (afterSource) { afterSource.stop(); afterSource.disconnect(); afterSource = null; }
      isPlaying = false;
      playBtn.innerHTML = PLAY_SVG;
    }

    function play() {
      if (!isLoaded) return;
      stopAll();

      beforeSource = audioCtx.createBufferSource();
      afterSource = audioCtx.createBufferSource();
      beforeSource.buffer = beforeBuffer;
      afterSource.buffer = afterBuffer;
      beforeSource.connect(beforeGainNode);
      afterSource.connect(afterGainNode);

      beforeGainNode.gain.value = activeIsAfter ? 0 : 1;
      afterGainNode.gain.value = activeIsAfter ? 1 : 0;

      beforeSource.start(0, position);
      afterSource.start(0, position);

      startTimestamp = audioCtx.currentTime - position;
      isPlaying = true;
      playBtn.innerHTML = PAUSE_SVG;
    }

    playBtn.addEventListener("click", async () => {
      if (!isLoaded) await ensureLoaded();
      if (audioCtx.state === "suspended") await audioCtx.resume();
      if (isPlaying) {
        position = audioCtx.currentTime - startTimestamp;
        stopAll();
      } else {
        play();
      }
    });

    toggle.addEventListener("click", () => {
      activeIsAfter = !activeIsAfter;
      if (beforeGainNode && afterGainNode) {
        beforeGainNode.gain.value = activeIsAfter ? 0 : 1;
        afterGainNode.gain.value = activeIsAfter ? 1 : 0;
      }
    });

    function updateUI() {
      if (isPlaying) {
        position = audioCtx.currentTime - startTimestamp;
        rangeEl.value = position;
        timeEl.textContent = fmtTime(position);
        if (position >= duration) {
          stopAll();
          position = 0;
          rangeEl.value = 0;
          timeEl.textContent = "0:00";
        }
      }
      requestAnimationFrame(updateUI);
    }
    updateUI();

    rangeEl.addEventListener("input", () => {
      position = parseFloat(rangeEl.value);
      if (isPlaying) play();
    });
  });
})();
</script>

</body>
</html>
